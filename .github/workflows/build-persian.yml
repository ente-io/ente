name: Build Persian APK

on:
  workflow_dispatch:
  push:
    branches: [persian-localized]

env:
  FLUTTER_VERSION: "3.24.3"
  API_ENDPOINT: "https://api.photos.degoogle.ir"

jobs:
  build:
    runs-on: ubuntu-latest
    
    defaults:
      run:
        working-directory: mobile

    steps:
      - name: Checkout code and submodules
        uses: actions/checkout@v4
        with:
          ref: persian-localized
          submodules: recursive

      - name: Free up disk space
        run: |
          echo "ğŸ§¹ Freeing disk space..."
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          df -h /

      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Install Flutter ${{ env.FLUTTER_VERSION }}
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Setup Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install Rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true

      - name: Install Flutter Rust Bridge
        run: cargo install flutter_rust_bridge_codegen --force

      - name: Generate Rust bindings
        working-directory: mobile/apps/photos
        run: flutter_rust_bridge_codegen generate

      - name: Apply Persian translations
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          if ! grep -r "Ø¨Ù‡\|Ø§Ø²\|Ø¯Ø±" apps/photos/lib/l10n/arb --include="*.arb" > /dev/null 2>&1; then
            echo "ğŸ”„ Translating ARB files..."
            python -m pip install --upgrade pip
            python -m pip install --upgrade pip
              if [ -f requirements.txt ]; then
                pip install -r requirements.txt
              else
                pip install openai python-dotenv requests
              fi 
              #python3 translate_arb.py
            
            if [ -f "merge_translations.py" ]; then
              echo "ğŸ”€ Merging translations..."
              #python3 merge_translations.py
            fi
            
            echo "âœ… Translation completed!"
          else
            echo "âœ… Translations already exist!"
          fi

      - name: Generate localization files
        working-directory: mobile/apps/photos
        run: |
          echo "ğŸŒ Generating l10n..."
          flutter gen-l10n

      - name: Flutter pub get
        working-directory: mobile/apps/photos
        run: flutter pub get

      - name: Build Release APK
        working-directory: mobile/apps/photos
        run: |
          echo "ğŸ—ï¸ Building APK with custom endpoint..."
          flutter build apk \
            --dart-define=endpoint=${{ env.API_ENDPOINT }} \
            --dart-define=cronetHttpNoPlay=true \
            --release \
            --flavor independent
          
          BUILD_DATE=$(date +%Y%m%d-%H%M)
          mv build/app/outputs/flutter-apk/app-independent-release.apk \
             build/app/outputs/flutter-apk/ente-persian-${BUILD_DATE}.apk
          
          echo "âœ… APK built successfully!"

      - name: Generate Checksum
        working-directory: mobile/apps/photos
        run: |
          cd build/app/outputs/flutter-apk/
          sha256sum ente-persian-*.apk | tee sha256sum.txt

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: ente-persian-apk
          path: |
            mobile/apps/photos/build/app/outputs/flutter-apk/ente-persian-*.apk
            mobile/apps/photos/build/app/outputs/flutter-apk/sha256sum.txt
          retention-days: 90

      - name: Build Summary
        working-directory: mobile/apps/photos
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Persian Build Completed!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸŒ API Endpoint: ${{ env.API_ENDPOINT }}"
          echo "ğŸ“¦ APK:"
          ls -lh build/app/outputs/flutter-apk/ente-persian-*.apk
          echo ""
          echo "ğŸ”’ Checksum:"
          cat build/app/outputs/flutter-apk/sha256sum.txt
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

