name: Build Ente Persian APK

on:
  push:
    branches: [ persian-localized ]
  workflow_dispatch:

env:
  FLUTTER_VERSION: "3.27.1"
  JAVA_VERSION: "17"
  API_ENDPOINT: "https://api.photos.degoogle.ir"

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Free up disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          sudo apt-get clean
          df -h

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: "zulu"
          java-version: ${{ env.JAVA_VERSION }}

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: "stable"
          cache: true

      - name: Install Rust (Stable)
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-linux-android,armv7-linux-androideabi,x86_64-linux-android

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: mobile/apps/photos/rust

      # ============================================
      # Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¬ÙˆØ¯ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Rust
      # ============================================
      - name: Check if Rust files exist
        id: check_rust
        run: |
          if [ -d "mobile/apps/photos/lib/src/rust" ]; then
            echo "rust_exists=true" >> $GITHUB_OUTPUT
            echo "âœ… Rust files already exist"
          else
            echo "rust_exists=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ Need to generate Rust bindings"
          fi

      # ============================================
      # Fix Dependencies FIRST (Ù‚Ø¨Ù„ Ø§Ø² pub get)
      # ============================================
      - name: Fix dependencies in pubspec.yaml
        working-directory: mobile/apps/photos
        run: |
          echo "ðŸ”§ Fixing dependencies..."
          
          # 1. Fix mockito version
          MOCKITO_VERSION=$(grep "mockito:" pubspec.yaml | grep -oP '\d+\.\d+\.\d+' || echo "not_found")
          echo "Current mockito version: $MOCKITO_VERSION"
          
          if [[ "$MOCKITO_VERSION" > "5.4.5" ]] || [[ "$MOCKITO_VERSION" == "not_found" ]]; then
            echo "âš ï¸ Downgrading mockito to 5.4.5"
            sed -i 's/mockito: .*/mockito: 5.4.5/' pubspec.yaml
          fi
          
          # 2. Add ffi if needed (for Rust bindings)
          if ! grep -q "^  ffi:" pubspec.yaml; then
            echo "âš ï¸ Adding ffi dependency"
            sed -i '/^dependencies:/a\  ffi: ^2.1.0' pubspec.yaml
          fi
          
          echo "âœ… Dependencies fixed!"
          echo "ðŸ“‹ Current dependencies:"
          grep -A 15 "^dependencies:" pubspec.yaml
          echo ""
          echo "ðŸ“‹ Dev dependencies:"
          grep -A 10 "^dev_dependencies:" pubspec.yaml

      # ============================================
      # Ù†ØµØ¨ Ø§Ø¨Ø²Ø§Ø±Ù‡Ø§ÛŒ Rust (ÙÙ‚Ø· Ø¯Ø± ØµÙˆØ±Øª Ù†ÛŒØ§Ø²)
      # ============================================
      - name: Install Rust tools
        if: steps.check_rust.outputs.rust_exists == 'false'
        run: |
          echo "ðŸ“¦ Installing cargo-expand..."
          cargo install cargo-expand --locked
          
          echo "ðŸ“¦ Installing flutter_rust_bridge_codegen 1.82.6..."
          cargo install flutter_rust_bridge_codegen --version 1.82.6 --locked

      - name: Get dependencies (pre-generate)
        if: steps.check_rust.outputs.rust_exists == 'false'
        working-directory: mobile/apps/photos
        run: |
          echo "ðŸ“¦ Running flutter pub get..."
          flutter pub get

      - name: Generate Rust bindings
        if: steps.check_rust.outputs.rust_exists == 'false'
        working-directory: mobile/apps/photos
        run: |
          echo "ðŸ”¨ Generating Rust bindings with CLI parameters"
          flutter_rust_bridge_codegen \
            --rust-input rust/src/api.rs \
            --dart-output lib/src/rust \
            --rust-crate-dir rust

      - name: Flutter doctor
        run: flutter doctor -v

      - name: Generate l10n
        run: flutter gen-l10n
        working-directory: mobile/apps/photos

      - name: Get dependencies (final)
        run: flutter pub get
        working-directory: mobile/apps/photos

      - name: Clean build
        run: flutter clean
        working-directory: mobile/apps/photos

      # ============================================
      # Build APK
      # ============================================
      - name: Build APK
        run: |
          flutter build apk \
            --release \
            --flavor independent \
            --dart-define=endpoint=${{ env.API_ENDPOINT }} \
            --dart-define=cronetHttpNoPlay=true \
            --no-tree-shake-icons
        working-directory: mobile/apps/photos

      - name: Rename and organize APK
        run: |
          cd mobile/apps/photos/build/app/outputs/flutter-apk
          APK_NAME="ente-persian-$(date +%Y%m%d-%H%M%S).apk"
          mv app-independent-release.apk "$APK_NAME"
          sha256sum "$APK_NAME" > checksums.txt

          echo "âœ… Build completed successfully!"
          echo "ðŸ“¦ APK: $APK_NAME"
          cat checksums.txt

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: ente-persian-build
          path: |
            mobile/apps/photos/build/app/outputs/flutter-apk/*.apk
            mobile/apps/photos/build/app/outputs/flutter-apk/checksums.txt
          retention-days: 90

