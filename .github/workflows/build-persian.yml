name: Build Ente Persian APK

on:
  push:
    branches: [ persian-localized ]
  workflow_dispatch:

env:
  FLUTTER_VERSION: "3.35.7"
  JAVA_VERSION: "17"
  API_ENDPOINT: "https://api.photos.degoogle.ir"

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Free up disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          sudo apt-get clean
          df -h

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: "zulu"
          java-version: ${{ env.JAVA_VERSION }}

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: "stable"
          cache: true

      - name: Install Rust (Stable)
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-linux-android,armv7-linux-androideabi,x86_64-linux-android

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: mobile/apps/photos/rust

      # ============================================
      # Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¬ÙˆØ¯ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Rust
      # ============================================
      - name: Check if Rust files exist
        id: check_rust
        run: |
          if [ -d "mobile/apps/photos/lib/src/rust" ]; then
            echo "rust_exists=true" >> $GITHUB_OUTPUT
            echo "âœ… Rust files already exist"
          else
            echo "rust_exists=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ Need to generate Rust bindings"
          fi

      # ============================================
      # Ø§ØµÙ„Ø§Ø­ pubspec.yaml (ÙÙ‚Ø· Ø¯Ø± ØµÙˆØ±Øª Ù†ÛŒØ§Ø² Ø¨Ù‡ generate)
      # ============================================
      - name: Fix pubspec.yaml dependencies
        if: steps.check_rust.outputs.rust_exists == 'false'
        working-directory: mobile/apps/photos
        run: |
          echo "ðŸ”§ Fixing pubspec.yaml..."
          
          # Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† ffi (Ø§Ú¯Ù‡ Ù†Ø¯Ø§Ø±Ù‡)
          if ! grep -q "^  ffi:" pubspec.yaml; then
            sed -i '/^dependencies:/a\  ffi: ^2.1.0' pubspec.yaml
            echo "âœ… Added ffi"
          fi
          
          echo "ðŸ“¦ Dependencies section:"
          sed -n '/^dependencies:/,/^dev_dependencies:/p' pubspec.yaml

      # ============================================
      # Ù†ØµØ¨ Ø§Ø¨Ø²Ø§Ø±Ù‡Ø§ÛŒ Rust (ÙÙ‚Ø· Ø¯Ø± ØµÙˆØ±Øª Ù†ÛŒØ§Ø²)
      # ============================================
      - name: Install Rust tools
        if: steps.check_rust.outputs.rust_exists == 'false'
        run: |
          echo "ðŸ“¦ Installing cargo-expand..."
          cargo install cargo-expand --locked
          
          echo "ðŸ“¦ Installing flutter_rust_bridge_codegen 1.82.6..."
          cargo install flutter_rust_bridge_codegen --version 1.82.6 --locked

      # ============================================
      # Get dependencies (Ù‚Ø¨Ù„ Ø§Ø² generate)
      # ============================================
      - name: Get dependencies (pre-generate)
        if: steps.check_rust.outputs.rust_exists == 'false'
        working-directory: mobile/apps/photos
        run: flutter pub get

      # ============================================
      # Generate Rust bindings
      # ============================================
      - name: Generate Rust bindings
        if: steps.check_rust.outputs.rust_exists == 'false'
        working-directory: mobile/apps/photos
        run: |
          echo "ðŸ”¨ Generating Rust bindings..."
          flutter_rust_bridge_codegen \
            --rust-input rust/src/api.rs \
            --dart-output lib/src/rust \
            --rust-crate-dir rust

      # ============================================
      # Ø¨Ù‚ÛŒÙ‡ Ù…Ø±Ø§Ø­Ù„ Build (Ù‡Ù…ÛŒØ´Ù‡ Ø§Ø¬Ø±Ø§ Ù…ÛŒâ€ŒØ´Ù‡)
      # ============================================
      - name: Flutter doctor
        run: flutter doctor -v

      - name: Generate l10n
        working-directory: mobile/apps/photos
        run: flutter gen-l10n

      - name: Get dependencies (final)
        working-directory: mobile/apps/photos
        run: flutter pub get

      - name: Clean build
        working-directory: mobile/apps/photos
        run: flutter clean

      - name: Build APK
        working-directory: mobile/apps/photos
        run: |
          flutter build apk \
            --release \
            --flavor independent \
            --dart-define=endpoint=${{ env.API_ENDPOINT }} \
            --dart-define=cronetHttpNoPlay=true \
            --no-tree-shake-icons

      - name: Rename and organize APK
        run: |
          cd mobile/apps/photos/build/app/outputs/flutter-apk
          APK_NAME="ente-persian-$(date +%Y%m%d-%H%M%S).apk"
          mv app-independent-release.apk "$APK_NAME"
          sha256sum "$APK_NAME" > checksums.txt
          echo "âœ… Build completed!"
          echo "ðŸ“¦ APK: $APK_NAME"
          cat checksums.txt

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: ente-persian-build
          path: |
            mobile/apps/photos/build/app/outputs/flutter-apk/*.apk
            mobile/apps/photos/build/app/outputs/flutter-apk/checksums.txt
          retention-days: 90

