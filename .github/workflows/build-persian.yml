name: Build Ente Persian APK

on:
  push:
    branches: [ persian-localized ]
  workflow_dispatch:

env:
  FLUTTER_VERSION: "3.35.7"
  JAVA_VERSION: "17"
  API_ENDPOINT: "https://api.photos.degoogle.ir"

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 90

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Free up disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo apt-get clean
          df -h

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: "zulu"
          java-version: ${{ env.JAVA_VERSION }}

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: "stable"
          cache: true

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-linux-android,armv7-linux-androideabi,x86_64-linux-android

      - name: Install Rust tools
        run: |
          cargo install flutter_rust_bridge_codegen@2.11.1 --locked
          cargo install cargo-expand --locked

      - name: Generate Rust bindings
        working-directory: mobile/apps/photos
        run: |
          flutter_rust_bridge_codegen \
            --rust-input rust/src/api/mod.rs \
            --dart-output lib/src/rust \
            --rust-crate-dir rust \
            --class-name RustLib \
            --dart-format-line-length 120

      - name: Verify bindings
        run: |
          ls -la mobile/apps/photos/lib/src/rust/
          ls -la mobile/apps/photos/rust/src/bridge_generated*

      - name: Flutter doctor
        run: flutter doctor -v

      - name: Get dependencies
        working-directory: mobile/apps/photos
        run: flutter pub get

      - name: Generate l10n
        working-directory: mobile/apps/photos
        run: flutter gen-l10n

      - name: Clean build cache
        working-directory: mobile/apps/photos
        run: flutter clean

      - name: Build APK
        working-directory: mobile/apps/photos
        run: |
          flutter build apk \
            --release \
            --flavor independent \
            --dart-define=endpoint=${{ env.API_ENDPOINT }} \
            --dart-define=cronetHttpNoPlay=true \
            --no-tree-shake-icons

      - name: Rename APK
        run: |
          cd mobile/apps/photos/build/app/outputs/flutter-apk
          APK_NAME="ente-persian-$(date +%Y%m%d-%H%M%S).apk"
          mv app-independent-release.apk "$APK_NAME"
          sha256sum "$APK_NAME" > checksums.txt
          echo "âœ… APK: $APK_NAME"
          cat checksums.txt

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: ente-persian-build
          path: |
            mobile/apps/photos/build/app/outputs/flutter-apk/*.apk
            mobile/apps/photos/build/app/outputs/flutter-apk/checksums.txt
          retention-days: 90

