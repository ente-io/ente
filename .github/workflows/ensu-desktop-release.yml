name: "Release (ensu desktop)"

on:
    push:
        # Run when a tag matching the pattern "ensu-v*" is pushed
        tags:
            - "ensu-v*"
    # Also allow manually running the workflow
    workflow_dispatch:

permissions:
    contents: write

jobs:
    release:
        strategy:
            fail-fast: false
            matrix:
                platform:
                    - os: ubuntu-22.04
                      rust-target: x86_64-unknown-linux-gnu
                    - os: macos-latest
                      rust-target: x86_64-apple-darwin
                    - os: macos-latest
                      rust-target: aarch64-apple-darwin
                    - os: windows-latest
                      rust-target: x86_64-pc-windows-msvc

        runs-on: ${{ matrix.platform.os }}

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 22
                  cache: "yarn"
                  cache-dependency-path: "web/yarn.lock"

            - name: Install Rust stable
              uses: dtolnay/rust-toolchain@stable
              with:
                  targets: ${{ matrix.platform.rust-target }}

            - name: Set macOS deployment target
              if: matrix.platform.os == 'macos-latest'
              run: echo "MACOSX_DEPLOYMENT_TARGET=10.15" >> $GITHUB_ENV

            - name: Install dependencies (Ubuntu only)
              if: matrix.platform.os == 'ubuntu-22.04'
              run: |
                  sudo apt-get update
                  sudo apt-get install -y libwebkit2gtk-4.0-dev libssl-dev libgtk-3-dev libayatana-appindicator3-dev librsvg2-dev

            - name: Rust cache
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.cargo/registry
                      ~/.cargo/git
                      desktop/ensu-tauri/src-tauri/target
                  key: ${{ runner.os }}-${{ matrix.platform.rust-target }}-cargo-ensu-release-${{ hashFiles('desktop/ensu-tauri/src-tauri/Cargo.lock') }}

            - name: Install web dependencies
              working-directory: web
              run: yarn install --frozen-lockfile

            - name: Build WASM
              working-directory: web
              run: yarn build:wasm

            - name: Install Tauri dependencies
              working-directory: desktop/ensu-tauri
              run: yarn install

            - name: Fetch Rust dependencies
              shell: bash
              working-directory: desktop/ensu-tauri/src-tauri
              run: cargo fetch

            - name: Patch llama.cpp mtmd sources
              shell: bash
              run: rust/llmchat/inference/tool/patch_llama_mtmd.sh

            - name: Build and release Tauri app
              uses: tauri-apps/tauri-action@v0
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                  TAURI_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
                  TAURI_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD }}
              with:
                  projectPath: desktop/ensu-tauri
                  tagName: ${{ github.ref_name }}
                  releaseName: "Ensu Desktop ${{ github.ref_name }}"
                  releaseBody: |
                      Desktop release for Ensu

                      **Platforms:**
                      - Linux (AppImage, deb)
                      - macOS (dmg, app)
                      - Windows (msi, exe)

                      Download the appropriate file for your platform below.
                  releaseDraft: true
                  prerelease: false
                  args: ${{ matrix.platform.rust-target != 'x86_64-unknown-linux-gnu' && format('--target {0}', matrix.platform.rust-target) || '' }}
