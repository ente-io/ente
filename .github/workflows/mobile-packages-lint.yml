name: "Lint (mobile packages)"

on:
    # Run when mobile/packages changes
    pull_request:
        paths:
            - "mobile/packages/**"
            - ".github/workflows/mobile-packages-lint.yml"
            - "mobile/analysis_options.yaml"
    # Allow manual trigger for testing
    workflow_dispatch:

env:
    FLUTTER_VERSION: "3.32.8"
    RUSTFLAGS: -D warnings

permissions:
    contents: read
    pull-requests: read  # Required for paths-filter

jobs:
    detect-changes:
        runs-on: ubuntu-latest
        outputs:
            packages: ${{ steps.filter.outputs.packages }}
            lint_photos: ${{ steps.filter.outputs.lint_photos }}
            lint_auth: ${{ steps.filter.outputs.lint_auth }}
            lint_locker: ${{ steps.filter.outputs.lint_locker }}
            lint_all: ${{ steps.filter.outputs.lint_all }}
            rust_changed: ${{ steps.filter.outputs.rust_changed }}
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Detect changed files
              uses: dorny/paths-filter@v3
              id: changes
              with:
                  filters: |
                      rust:
                        - 'mobile/packages/rust/**/*.rs'
                        - 'mobile/packages/rust/**/Cargo.toml'
                        - 'mobile/packages/rust/**/Cargo.lock'
                        - 'mobile/apps/photos/rust/**/*.rs'
                        - 'mobile/apps/photos/rust/**/Cargo.toml'
                        - 'rust/core/**/*.rs'
                      workflow:
                        - '.github/workflows/mobile-packages-lint.yml'
                      analysis:
                        - 'mobile/analysis_options.yaml'
                      packages:
                        - 'mobile/packages/**'

            - name: Determine affected packages
              id: filter
              run: |
                  # Get list of changed files
                  CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} || echo "")

                  # Run dependency analyzer
                  RESULT=$(./.github/scripts/get-affected-packages.sh $CHANGED_FILES)

                  echo "Analysis result:"
                  echo "$RESULT"

                  # Extract values from JSON
                  PACKAGES=$(echo "$RESULT" | jq -r '.packages')
                  LINT_PHOTOS=$(echo "$RESULT" | jq -r '.lint_photos')
                  LINT_AUTH=$(echo "$RESULT" | jq -r '.lint_auth')
                  LINT_LOCKER=$(echo "$RESULT" | jq -r '.lint_locker')
                  LINT_ALL=$(echo "$RESULT" | jq -r '.lint_all')

                  # Set outputs
                  echo "packages=$PACKAGES" >> $GITHUB_OUTPUT
                  echo "lint_photos=$LINT_PHOTOS" >> $GITHUB_OUTPUT
                  echo "lint_auth=$LINT_AUTH" >> $GITHUB_OUTPUT
                  echo "lint_locker=$LINT_LOCKER" >> $GITHUB_OUTPUT
                  echo "lint_all=$LINT_ALL" >> $GITHUB_OUTPUT
                  echo "rust_changed=${{ steps.changes.outputs.rust }}" >> $GITHUB_OUTPUT

                  echo "Affected packages: $PACKAGES"
                  echo "Lint photos: $LINT_PHOTOS"
                  echo "Lint auth: $LINT_AUTH"
                  echo "Lint locker: $LINT_LOCKER"
                  echo "Lint all: $LINT_ALL"
                  echo "Rust changed: ${{ steps.changes.outputs.rust }}"

    packages-lint:
        needs: detect-changes
        runs-on: ubuntu-latest
        # Skip if no packages need linting
        if: needs.detect-changes.outputs.lint_all == 'true' || needs.detect-changes.outputs.packages != ''
        steps:
            - name: Checkout code and submodules
              uses: actions/checkout@v4
              with:
                  submodules: recursive

            - name: Install Flutter ${{ env.FLUTTER_VERSION  }}
              uses: subosito/flutter-action@v2
              with:
                  channel: "stable"
                  flutter-version: ${{ env.FLUTTER_VERSION  }}
                  cache: true

            - name: Cache Rust dependencies
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.cargo/registry
                      ~/.cargo/git
                      mobile/packages/rust/rust/target
                  key: ${{ runner.os }}-cargo-packages-${{ hashFiles('mobile/packages/**/Cargo.lock') }}

            - name: Install Flutter Rust Bridge
              run: cargo install flutter_rust_bridge_codegen

            - name: Generate Rust bindings (Core)
              run: flutter_rust_bridge_codegen generate
              working-directory: mobile/packages/rust

            - name: Generate strings localizations
              run: flutter gen-l10n
              working-directory: mobile/packages/strings

            # Lint all affected packages conditionally
            - name: Lint package - accounts
              if: needs.detect-changes.outputs.lint_all == 'true' || contains(needs.detect-changes.outputs.packages, 'accounts')
              run: flutter pub get && flutter analyze --no-fatal-infos
              working-directory: mobile/packages/accounts

            - name: Lint package - base
              if: needs.detect-changes.outputs.lint_all == 'true' || contains(needs.detect-changes.outputs.packages, 'base')
              run: flutter pub get && flutter analyze --no-fatal-infos
              working-directory: mobile/packages/base

            - name: Lint package - configuration
              if: needs.detect-changes.outputs.lint_all == 'true' || contains(needs.detect-changes.outputs.packages, 'configuration')
              run: flutter pub get && flutter analyze --no-fatal-infos
              working-directory: mobile/packages/configuration

            - name: Lint package - scoped_dir_access
              if: needs.detect-changes.outputs.lint_all == 'true' || contains(needs.detect-changes.outputs.packages, 'scoped_dir_access')
              run: flutter pub get && flutter analyze --no-fatal-infos
              working-directory: mobile/packages/scoped_dir_access

            - name: Lint package - ente_crypto_api
              if: needs.detect-changes.outputs.lint_all == 'true' || contains(needs.detect-changes.outputs.packages, 'ente_crypto_api')
              run: flutter pub get && flutter analyze --no-fatal-infos
              working-directory: mobile/packages/ente_crypto_api

            - name: Lint package - ente_crypto_dart_adapter
              if: needs.detect-changes.outputs.lint_all == 'true' || contains(needs.detect-changes.outputs.packages, 'ente_crypto_dart_adapter')
              run: flutter pub get && flutter analyze --no-fatal-infos
              working-directory: mobile/packages/ente_crypto_dart_adapter

            - name: Lint package - ente_icons
              if: needs.detect-changes.outputs.lint_all == 'true' || contains(needs.detect-changes.outputs.packages, 'ente_icons')
              run: flutter pub get && flutter analyze --no-fatal-infos
              working-directory: mobile/packages/ente_icons

            - name: Lint package - ente_pure_utils
              if: needs.detect-changes.outputs.lint_all == 'true' || contains(needs.detect-changes.outputs.packages, 'ente_pure_utils')
              run: flutter pub get && flutter analyze --no-fatal-infos
              working-directory: mobile/packages/ente_pure_utils

            - name: Lint package - events
              if: needs.detect-changes.outputs.lint_all == 'true' || contains(needs.detect-changes.outputs.packages, 'events')
              run: flutter pub get && flutter analyze --no-fatal-infos
              working-directory: mobile/packages/events

            - name: Lint package - legacy
              if: needs.detect-changes.outputs.lint_all == 'true' || contains(needs.detect-changes.outputs.packages, 'legacy')
              run: flutter pub get && flutter analyze --no-fatal-infos
              working-directory: mobile/packages/legacy

            - name: Lint package - lock_screen
              if: needs.detect-changes.outputs.lint_all == 'true' || contains(needs.detect-changes.outputs.packages, 'lock_screen')
              run: flutter pub get && flutter analyze --no-fatal-infos
              working-directory: mobile/packages/lock_screen

            - name: Lint package - log_viewer
              if: needs.detect-changes.outputs.lint_all == 'true' || contains(needs.detect-changes.outputs.packages, 'log_viewer')
              run: flutter pub get && flutter analyze --no-fatal-infos
              working-directory: mobile/packages/log_viewer

            - name: Lint package - logging
              if: needs.detect-changes.outputs.lint_all == 'true' || contains(needs.detect-changes.outputs.packages, 'logging')
              run: flutter pub get && flutter analyze --no-fatal-infos
              working-directory: mobile/packages/logging

            - name: Lint package - native_video_editor
              if: needs.detect-changes.outputs.lint_all == 'true' || contains(needs.detect-changes.outputs.packages, 'native_video_editor')
              run: flutter pub get && flutter analyze --no-fatal-infos
              working-directory: mobile/packages/native_video_editor

            - name: Lint package - network
              if: needs.detect-changes.outputs.lint_all == 'true' || contains(needs.detect-changes.outputs.packages, 'network')
              run: flutter pub get && flutter analyze --no-fatal-infos
              working-directory: mobile/packages/network

            - name: Lint package - qr
              if: needs.detect-changes.outputs.lint_all == 'true' || contains(needs.detect-changes.outputs.packages, 'qr')
              run: flutter pub get && flutter analyze --no-fatal-infos
              working-directory: mobile/packages/qr

            - name: Lint package - sharing
              if: needs.detect-changes.outputs.lint_all == 'true' || contains(needs.detect-changes.outputs.packages, 'sharing')
              run: flutter pub get && flutter analyze --no-fatal-infos
              working-directory: mobile/packages/sharing

            - name: Lint package - strings
              if: needs.detect-changes.outputs.lint_all == 'true' || contains(needs.detect-changes.outputs.packages, 'strings')
              run: flutter pub get && flutter analyze --no-fatal-infos
              working-directory: mobile/packages/strings

            - name: Lint package - ui
              if: needs.detect-changes.outputs.lint_all == 'true' || contains(needs.detect-changes.outputs.packages, 'ui')
              run: flutter pub get && flutter analyze --no-fatal-infos
              working-directory: mobile/packages/ui

            - name: Lint package - utils
              if: needs.detect-changes.outputs.lint_all == 'true' || contains(needs.detect-changes.outputs.packages, 'utils')
              run: flutter pub get && flutter analyze --no-fatal-infos
              working-directory: mobile/packages/utils

    rust-lint:
        needs: detect-changes
        runs-on: ubuntu-latest
        if: needs.detect-changes.outputs.rust_changed == 'true'
        steps:
            - name: Checkout code and submodules
              uses: actions/checkout@v4
              with:
                  submodules: recursive

            - name: Cache Rust dependencies
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.cargo/registry
                      ~/.cargo/git
                      mobile/packages/rust/rust/target
                  key: ${{ runner.os }}-cargo-packages-${{ hashFiles('mobile/packages/**/Cargo.lock') }}

            - name: Install Flutter Rust Bridge
              run: cargo install flutter_rust_bridge_codegen

            - name: Generate Rust bindings (Core)
              run: flutter_rust_bridge_codegen generate
              working-directory: mobile/packages/rust

            - name: Check formatting (ente_rust)
              working-directory: mobile/packages/rust/rust
              run: cargo fmt -- src/frb_generated.rs && cargo fmt --check

            - name: Run clippy (ente_rust)
              working-directory: mobile/packages/rust/rust
              run: cargo clippy --all-targets --all-features

            - name: Build (ente_rust)
              working-directory: mobile/packages/rust/rust
              run: cargo build

            - name: Test (ente_rust)
              working-directory: mobile/packages/rust/rust
              run: cargo test

            - name: Generate Rust bindings (photos app)
              run: flutter_rust_bridge_codegen generate
              working-directory: mobile/apps/photos

            - name: Check formatting (ente_photos_rust)
              working-directory: mobile/apps/photos/rust
              run: cargo fmt -- src/frb_generated.rs && cargo fmt --check

            - name: Run clippy (ente_photos_rust)
              working-directory: mobile/apps/photos/rust
              run: cargo clippy --all-targets --all-features

            - name: Build (ente_photos_rust)
              working-directory: mobile/apps/photos/rust
              run: cargo build

            - name: Test (ente_photos_rust)
              working-directory: mobile/apps/photos/rust
              run: cargo test

    apps-lint:
        needs: detect-changes
        runs-on: ubuntu-latest
        if: needs.detect-changes.outputs.lint_photos == 'true' || needs.detect-changes.outputs.lint_auth == 'true' || needs.detect-changes.outputs.lint_locker == 'true'
        steps:
            - name: Checkout code and submodules
              uses: actions/checkout@v4
              with:
                  submodules: recursive

            - name: Install Flutter ${{ env.FLUTTER_VERSION  }}
              uses: subosito/flutter-action@v2
              with:
                  channel: "stable"
                  flutter-version: ${{ env.FLUTTER_VERSION  }}
                  cache: true

            - name: Cache Rust dependencies
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.cargo/registry
                      ~/.cargo/git
                      mobile/packages/rust/rust/target
                  key: ${{ runner.os }}-cargo-packages-${{ hashFiles('mobile/packages/**/Cargo.lock') }}

            - name: Install Flutter Rust Bridge
              if: needs.detect-changes.outputs.lint_photos == 'true'
              run: cargo install flutter_rust_bridge_codegen

            - name: Generate Rust bindings (Core package)
              if: needs.detect-changes.outputs.lint_photos == 'true'
              run: flutter_rust_bridge_codegen generate
              working-directory: mobile/packages/rust

            - name: Generate Rust bindings (photos app)
              if: needs.detect-changes.outputs.lint_photos == 'true'
              run: flutter_rust_bridge_codegen generate
              working-directory: mobile/apps/photos

            - name: Generate strings localizations
              run: flutter gen-l10n
              working-directory: mobile/packages/strings

            - name: Lint app - photos
              if: needs.detect-changes.outputs.lint_photos == 'true'
              run: flutter pub get && flutter analyze --no-fatal-infos
              working-directory: mobile/apps/photos

            - name: Lint app - auth
              if: needs.detect-changes.outputs.lint_auth == 'true'
              run: flutter pub get && flutter analyze --no-fatal-infos
              working-directory: mobile/apps/auth

            - name: Lint app - locker
              if: needs.detect-changes.outputs.lint_locker == 'true'
              run: flutter pub get && flutter analyze --no-fatal-infos
              working-directory: mobile/apps/locker
